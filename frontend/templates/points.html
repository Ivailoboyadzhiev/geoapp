<!DOCTYPE html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <title>–°–ø–∏—Å—ä–∫ —Å —Ç–æ—á–∫–∏</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(to right, #dfe9f3, #ffffff);
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .container {
        background-color: white;
        margin-top: 2em;
        padding: 1.5em;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 900px;
      }
      .actions {
        margin-bottom: 1em;
      }
      button {
        padding: 0.5em 1em;
        font-size: 1em;
        margin-right: 0.5em;
        background-color: #2e86de;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #1b4f72;
      }
      .delete-btn {
        background-color: #e74c3c;
      }
      .delete-btn:hover {
        background-color: #c0392b;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        padding: 0.75em;
        border: 1px solid #ddd;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>–°–ø–∏—Å—ä–∫ —Å —Ç–æ—á–∫–∏</h1>
      <div class="actions">
        <button onclick="window.location.href='/map'">–ö—ä–º –∫–∞—Ä—Ç–∞—Ç–∞</button>
        <button onclick="fetchPoints()">–û–±–Ω–æ–≤–∏ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞</button>
      </div>
      <table id="pointsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>–®–∏—Ä–∏–Ω–∞</th>
            <th>–î—ä–ª–∂–∏–Ω–∞</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="pointsBody"></tbody>
      </table>
    </div>

    <!-- –ú–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü -->
    <div
      id="editModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      "
    >
      <div
        style="
          background: white;
          margin: 10% auto;
          padding: 20px;
          border-radius: 8px;
          width: 300px;
          position: relative;
        "
      >
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Ç–æ—á–∫–∞</h3>
        <label
          >–®–∏—Ä–∏–Ω–∞:
          <input type="number" id="modal-lat" step="any" required /></label
        ><br /><br />
        <label
          >–î—ä–ª–∂–∏–Ω–∞:
          <input type="number" id="modal-lng" step="any" required /></label
        ><br /><br />
        <label>–û–ø–∏—Å–∞–Ω–∏–µ: <input type="text" id="modal-desc" required /></label
        ><br /><br />
        <button onclick="submitEdit()">–ó–∞–ø–∞–∑–∏</button>
        <button onclick="closeModal()">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
    </div>

    <script>
      let editId = null;

      function openEditModal(id, lat, lng, desc) {
        editId = id;
        document.getElementById("modal-lat").value = lat;
        document.getElementById("modal-lng").value = lng;
        document.getElementById("modal-desc").value = desc;
        document.getElementById("editModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function submitEdit() {
        const newLat = parseFloat(document.getElementById("modal-lat").value);
        const newLng = parseFloat(document.getElementById("modal-lng").value);
        const newDesc = document.getElementById("modal-desc").value;

        fetch(`/update_point/${editId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            latitude: newLat,
            longitude: newLng,
            description: newDesc,
          }),
        })
          .then((res) => {
            if (res.ok) {
              alert(" –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–µ–Ω–æ!");
              fetchPoints();
            } else {
              alert(" –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ.");
            }
          })
          .catch(() => alert("–ú—Ä–µ–∂–æ–≤–∞ –≥—Ä–µ—à–∫–∞."));

        closeModal();
      }

      async function fetchPoints() {
        try {
          const response = await fetch("/points");
          const points = await response.json();
          const tbody = document.getElementById("pointsBody");
          tbody.innerHTML = "";
          points.forEach((point) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${point.id}</td>
            <td>${point.latitude}</td>
            <td>${point.longitude}</td>
            <td>${point.description}</td>
            <td>
              <button onclick="openEditModal(${point.id}, ${point.latitude}, ${point.longitude}, '${point.description}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
              <button class="delete-btn" onclick="deletePoint(${point.id})">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
            </td>
          `;
            tbody.appendChild(row);
          });
        } catch (err) {
          console.error("Failed to fetch points:", err);
        }
      }

      async function deletePoint(id) {
        if (!confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–æ—á–∫–∞—Ç–∞?")) return;
        try {
          const res = await fetch(`/delete_point/${id}`, { method: "DELETE" });
          if (res.ok) fetchPoints();
          else alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ");
        } catch (err) {
          console.error(err);
          alert("–ù–µ—É—Å–ø–µ—à–Ω–∞ –∑–∞—è–≤–∫–∞");
        }
      }

      window.addEventListener("focus", fetchPoints);
      fetchPoints();
    </script>
  </body>
</html>
